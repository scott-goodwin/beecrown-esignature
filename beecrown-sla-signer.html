<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beecrown Logistics - Service Level Agreement</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --beecrown-purple: #6B2D8F;
            --beecrown-green: #8BC53F;
            --primary: #2c3e50;
            --text: #333;
            --bg: #f5f5f5;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: var(--bg);
            padding: 0;
            line-height: 1.6;
            color: var(--text);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
        }

        /* Step 1: Initial Form */
        .initial-form-container {
            padding: 3rem;
            max-width: 600px;
            margin: 2rem auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo-container img {
            max-width: 300px;
            height: auto;
        }

        .initial-form-container h1 {
            color: var(--beecrown-purple);
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .initial-form-container p {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--beecrown-purple);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input.error,
        .form-group textarea.error {
            border-color: #dc3545;
        }

        .form-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
            font-weight: 500;
        }

        .form-error.show {
            display: block;
        }

        .general-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
            margin-bottom: 1rem;
            display: none;
            font-weight: 600;
        }

        .general-error.show {
            display: block;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: var(--beecrown-purple);
            color: white;
        }

        .btn-primary:hover {
            background: #5a2578;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 45, 143, 0.3);
        }

        .btn-success {
            background: var(--beecrown-green);
            color: white;
        }

        .btn-success:hover {
            background: #7ab335;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 197, 63, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Step 2: Document View */
        .document-container {
            display: none;
            padding: 3rem;
            background: white;
        }

        .document-container.active {
            display: block;
        }

        .document-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--beecrown-purple);
        }

        .document-header img {
            max-width: 300px;
            margin-bottom: 1rem;
        }

        .document-title {
            font-size: 1.5rem;
            color: var(--beecrown-purple);
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border: 2px solid #000;
        }

        .info-table td {
            padding: 0.75rem;
            border: 1px solid #000;
        }

        .info-table td:first-child {
            font-weight: bold;
            width: 30%;
            background: #f0f0f0;
        }

        .filled-info {
            color: var(--beecrown-purple);
            font-weight: 600;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 2rem 0 1rem 0;
            color: var(--primary);
        }

        .terms-list {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .terms-list li {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        .declaration-box {
            background: #f8f9fa;
            padding: 1.5rem;
            border-left: 4px solid var(--beecrown-purple);
            margin: 2rem 0;
            font-weight: 500;
        }

        .signature-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #ddd;
        }

        .signature-section h3 {
            color: var(--beecrown-purple);
            margin-bottom: 1rem;
        }

        .signature-instruction {
            background: #fff3cd;
            padding: 1rem;
            border-left: 4px solid #ffc107;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .signature-pad {
            border: 3px solid var(--beecrown-purple);
            border-radius: 4px;
            cursor: crosshair;
            display: block;
            margin: 1rem 0;
            background: #fafafa;
            width: 100%;
            max-width: 100%;
        }

        .signature-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .signature-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .sig-box {
            padding: 1rem;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .sig-box strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .company-signature {
            text-align: center;
        }

        .company-signature img {
            max-width: 150px;
            margin: 1rem 0;
        }

        .status-message {
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-message.success {
            background: rgba(139, 197, 63, 0.1);
            border: 2px solid var(--beecrown-green);
            color: #4a7c1f;
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #dc3545;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }

        .spinner {
            border: 4px solid rgba(107, 45, 143, 0.3);
            border-top: 4px solid var(--beecrown-purple);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-section {
            background: var(--beecrown-purple);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem;
        }

        .config-section h2 {
            margin-bottom: 1.5rem;
        }

        .config-section input {
            background: white;
            color: var(--text);
        }

        @media print {
            .signature-controls,
            .btn,
            .config-section,
            #submitBtn,
            .signature-instruction {
                display: none !important;
            }
            
            .signature-pad {
                border: 2px solid #000 !important;
                page-break-inside: avoid;
            }
            
            body {
                background: white;
            }
            
            .document-container {
                box-shadow: none;
            }
        }

        .pdf-generation {
            .signature-controls,
            .btn,
            .config-section,
            #submitBtn,
            .signature-instruction,
            .status-message,
            .loading {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .initial-form-container,
            .document-container {
                padding: 1.5rem;
            }

            .signature-info {
                grid-template-columns: 1fr;
            }

            .document-header img {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Configuration Section -->
    <div class="config-section" id="configSection">
        <h2>n8n Webhook Configuration</h2>
        <div class="form-group">
            <label for="webhookUrl">n8n Webhook URL:</label>
            <input type="url" id="webhookUrl" placeholder="https://your-n8n-instance.com/webhook/...">
        </div>
        <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
    </div>

    <div class="container">
        <!-- Step 1: Initial Information Form -->
        <div class="initial-form-container" id="initialForm">
            <div class="logo-container">
                <div style="text-align: center;">
                    <div style="font-size: 48px; font-weight: bold; color: #6B2D8F; font-family: Arial, sans-serif; letter-spacing: -1px;">Beecrown</div>
                    <div style="font-size: 20px; color: #8BC53F; font-weight: 600; margin-top: -8px;">LOGISTICS LTD</div>
                    <div style="font-size: 11px; color: #6B2D8F; letter-spacing: 2px; margin-top: 2px;">THE POWER OF DELIVERY</div>
                </div>
            </div>

            <h1>Service Level Agreement</h1>
            <p>Sub-Contractors providing services to Beecrown Logistics Ltd</p>
            <p style="font-size: 0.9rem; color: #666;">Please enter your details below to view and sign the agreement</p>

            <form id="supplierForm" onsubmit="showDocument(event)">
                <div id="generalError" class="general-error">
                    ⚠️ Please fill in all required fields before continuing
                </div>

                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" name="firstName" required 
                           placeholder="Enter your first name">
                    <div class="form-error" id="firstNameError">First name is required</div>
                </div>

                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" required 
                           placeholder="Enter your last name">
                    <div class="form-error" id="lastNameError">Last name is required</div>
                </div>

                <div class="form-group">
                    <label for="driverReference">Driver Reference *</label>
                    <input type="text" id="driverReference" name="driverReference" required
                           placeholder="e.g., DRV-12345">
                    <div class="form-error" id="driverReferenceError">Driver reference is required</div>
                </div>

                <div class="form-group">
                    <label for="supplierEmail">Email Address *</label>
                    <input type="email" id="supplierEmail" name="supplierEmail" required
                           placeholder="your.email@example.com">
                    <div class="form-error" id="supplierEmailError">Valid email is required</div>
                </div>

                <div class="form-group">
                    <label for="addressLine1">Address Line 1 *</label>
                    <input type="text" id="addressLine1" name="addressLine1" required
                           placeholder="Street address">
                    <div class="form-error" id="addressLine1Error">Address line 1 is required</div>
                </div>

                <div class="form-group">
                    <label for="addressLine2">Address Line 2</label>
                    <input type="text" id="addressLine2" name="addressLine2"
                           placeholder="Apartment, suite, unit, etc. (optional)">
                </div>

                <div class="form-group">
                    <label for="town">Town/City *</label>
                    <input type="text" id="town" name="town" required
                           placeholder="Town or city">
                    <div class="form-error" id="townError">Town/City is required</div>
                </div>

                <div class="form-group">
                    <label for="postcode">Postcode *</label>
                    <input type="text" id="postcode" name="postcode" required
                           placeholder="e.g., BL1 4DH">
                    <div class="form-error" id="postcodeError">Postcode is required</div>
                </div>

                <button type="submit" class="btn btn-primary">
                    Continue to Agreement
                </button>
            </form>
        </div>

        <!-- Step 2: Document with Signature -->
        <div class="document-container" id="documentContent">
            <div class="document-header">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="display: inline-block; position: relative;">
                        <div style="font-size: 48px; font-weight: bold; color: #6B2D8F; font-family: Arial, sans-serif; letter-spacing: -1px;">Beecrown</div>
                        <div style="font-size: 20px; color: #8BC53F; font-weight: 600; margin-top: -8px;">LOGISTICS LTD</div>
                        <div style="font-size: 11px; color: #6B2D8F; letter-spacing: 2px; margin-top: 2px;">THE POWER OF DELIVERY</div>
                    </div>
                </div>

                <h1 class="document-title">Service Level Agreement – Sub-Contractors providing<br>services to Beecrown Logistics Ltd</h1>
            </div>

            <table class="info-table">
                <tr>
                    <td><strong>Company</strong></td>
                    <td><strong>Address</strong></td>
                </tr>
                <tr>
                    <td>Beecrown Logistics Ltd</td>
                    <td>Hamill House, 112-116 Chorley New Road, Bolton, BL1 4DH</td>
                </tr>
            </table>

            <p style="margin-bottom: 1rem;">(hereafter referred to as <strong>"the Company"</strong>)</p>
            <p style="margin-bottom: 1rem;"><strong>And</strong></p>

            <table class="info-table">
                <tr>
                    <td><strong>Name</strong></td>
                    <td><strong>Address</strong></td>
                </tr>
                <tr>
                    <td><span class="filled-info" id="displayName"></span></td>
                    <td><span class="filled-info" id="displayAddress"></span></td>
                </tr>
            </table>

            <p style="margin-bottom: 2rem;">(Name & Address - hereafter referred to as <strong>"the Supplier"</strong>)</p>

            <p style="margin-bottom: 1rem;"><strong>This Agreement is made on the date of the last signature below</strong></p>
            <p style="margin-bottom: 1rem;"><strong>Between:</strong></p>

            <ol class="terms-list">
                <li>Beecrown Logistics LTD a company incorporated in England and Wales with registered number 11440403 whose registered office is at Hamill House 112 - 116 Chorley New Road Bolton, BL1 4DH, We can deduct money if the van is hired from us (Beecrown Logistics LTD) this amount will be agreed before we hire out the van to you on a separate van hire agreement which would detail the terms and conditions.</li>

                <li>All expenses such as fuel etc are included within the agreed Day rate unless authorised by senior management.</li>

                <li>You are to understand the requirements of drivers hour's regulations and will ensure that appropriate rest periods are taken.</li>

                <li>The vehicles are your responsibility and, the vehicles must always be locked if unattended to and the keys must never be left in the ignition.</li>

                <li>Anyone who wishes to leave and stop providing their services must provide a formal 2 weeks' notice. If this has not been adhered to then we hold the right to delay, hold or keep the drivers' payments to cover costs incurred to find replacement.</li>

                <li>A 50% route deduction will be made to any driver that does not show up to work.</li>

                <li>Payments vary for each respective depots and will be paid accordingly matching to the pay dates that will be provided.</li>

                <li>If you wish to seek redress for any complaints relating to your assignment then you should notify your immediate supervisor in writing, specifying the grounds for your complaint. If your complaint relates to your immediate supervisor, then you can instead notify the Owner of the business. Further information can be found in the complaints Procedure.</li>

                <li>We hold the right to terminate this contract at any time if you have committed any offence in relation to the following: breaking the law, fraud, and failure to comply with this contract and company policies.</li>

                <li>Any Damages to Rental vans will be charged at the excess amount on the vehicle.</li>

                <li>The terms of payment vary depending on the specific contract for which services are rendered, ranging from payment in arrears spanning 2, 3, or 4 weeks. These terms are subject to agreement by your respective senior manager.</li>

                <li>All Parcels are the driver's responsibility, Any Parcels that are lost and/or stolen due to driver negligence will be chargeable to the individual drivers.</li>
            </ol>

            <h2 class="section-title">Hours of Work</h2>
            <ol class="terms-list" start="13">
                <li>Monies can be held for minimum 14 days or kept if there is damages, pcn's, accident or claims</li>

                <li>You will be completing a route which can approximately take around 9 hours to complete however it could also be longer possibly around 10 hours depending on the area you are delivering in on the day</li>

                <li>A mandatory rest period must be taken for 30 minutes during your route (this is an unpaid break)</li>

                <li>You must provide reasonable service for additional hours to meet our business requirements without additional payment.</li>

                <li>Monies can be held for minimum 14 days or kept if there is damages, pcn's, accident or claims</li>
            </ol>

            <p style="margin: 1.5rem 0;">All parcels must be delivered in accordance with the guidelines provided by the service partners. Any parcels that are not delivered within the rules and regulations may hold a fine and this will be charged to you. This includes scanners, delivering, parcels, damage, loss, theft and wrong/late deliveries.</p>

            <p style="margin: 1.5rem 0;">All parcels scanned to the van are your responsibility until either delivered or returned to the depot for scan off. Whilst your responsibility, any stolen, damaged or missing parcels due to neglect will be charged back to you and payments held to cover any claim.</p>

            <h2 class="section-title">Schedule 3 – Health & Safety and Security Requirements</h2>
            <ol class="terms-list">
                <li>The Supplier confirms that to provide the services safely and legally, they can meet the following before the commencement of the services (and agrees the Company can provide such information to its End-user client):
                    <ol style="list-style-type: lower-alpha; margin-left: 2rem; margin-top: 0.5rem;">
                        <li>is eligible to work in a self-employed capacity in the United Kingdom (per Government best practice requirements) and has registered with HM Revenue & Customs as self-employed (and can provide evidence upon request);</li>
                        <li>Is over 18 years of age;</li>
                        <li>Can confirm current work status and reasons for leaving previous work for previous twenty-four (24) months</li>
                        <li>passes a criminal background check, including but not limited to driving offences;</li>
                        <li>Confirmation that in providing services to the company, The Supplier will not be in breach of any other regulatory requirement;</li>
                        <li>Passes a Medical fitness for work check;</li>
                        <li>Passes a drug and alcohol screening test;</li>
                        <li>Holds a current and valid driving licence (either a UK licence or a European Community/European Economic Area (EC/EEA) license, but if the latter, they must hold a valid driving license counterpart for non-GB license holders (DELLA D9 form));</li>
                        <li>Has had no major preventable collisions within the previous three years;</li>
                        <li>Does not have more than 6 penalty points (endorsements) on their driving license;</li>
                        <li>Has not committed more than 3 driving-related offences of any kind in the last 4 years;</li>
                        <li>Does not currently have penalty points (endorsements) on their driving licence in relation to Offence Codes CD40, CD50, CD60, CD70, CD80, or CD90;</li>
                        <li>Does not currently have penalty points (endorsements) on their driving licence in relation to Offence Codes DD40, DD60, DD80, DD90;</li>
                        <li>Does not currently have penalty points (endorsements) on their driving licence in relation to Offence Codes DR10, DR20, DR30, DR40, DR50, DR60, DR70, DR80, DR90;</li>
                        <li>Does not currently have penalty points (endorsements) on their driving license in relation to Offence Codes IN10, MS50, TT99, or UT50;</li>
                        <li>Is not currently disqualified from driving (this includes having their license suspended);</li>
                        <li>Does not have any unspent convictions on their criminal record (driving-related or other).</li>
                        <li>Can speak fluent English, has a high level of written English skills, and passes appropriate numeracy tests.</li>
                        <li>Confirmation of whether the Supplier has previously ceased providing services to the Company or its End-user client for any reasons of unsuitability</li>
                    </ol>
                </li>

                <li>During the provision of the services, the Supplier agrees and consents that the Company may undertake ongoing checks at such intervals as it deems appropriate, with no further notice to the Supplier, of any or all of the conditions listed in Schedule 3 1(a) – (s) and may disclose this information to any End-user client the Supplier chooses to provide their services to.</li>
            </ol>

            <div class="declaration-box">
                <strong>Declaration</strong><br><br>
                I understand the terms and conditions of this position and will abide by all rules and regulations and the contract content any breach may lead to termination as stated above.
            </div>

            <div class="signature-section">
                <h3>Contractor Signature</h3>
                <div class="signature-instruction">
                    ⚠️ <strong>Important:</strong> You must sign in the box below before you can submit this agreement. Use your mouse or touchscreen to draw your signature.
                </div>
                <div class="signature-controls">
                    <button type="button" class="btn-secondary" onclick="clearSignature()">Clear Signature</button>
                </div>
                <canvas id="signaturePad" class="signature-pad" width="800" height="200"></canvas>

                <div class="signature-info">
                    <div class="sig-box">
                        <strong>I, the Independent Contractor, understand and accept in full the terms set out within this agreement.</strong>
                        <div style="margin-top: auto; padding-top: 2rem;">
                            <p><strong>Name:</strong> <span class="filled-info" id="signerName"></span></p>
                            <p><strong>Date:</strong> <span id="signatureDate"></span></p>
                            <p><strong>Position:</strong> Independent Contractor</p>
                            <p><strong>Signature:</strong></p>
                            <div id="contractorSignatureDisplay" style="min-height: 60px; border-bottom: 1px solid #333; margin-top: 0.5rem;"></div>
                        </div>
                    </div>

                    <div class="sig-box company-signature">
                        <strong>This agreement may only be varied by a document signed by Independent Contractor and Supplier</strong>
                        <div style="margin-top: auto; padding-top: 2rem;">
                            <p><strong>Name:</strong> Ghazalee Khan</p>
                            <p><strong>Date:</strong> As Per Signed Contractor Date</p>
                            <p><strong>Position:</strong> Director</p>
                            <p><strong>Signature:</strong></p>
                            <img src="data:image/webp;base64,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" 
                                 alt="Director Signature" 
                                 style="max-width: 150px; height: auto; margin-top: 0.5rem;">
                            <p style="margin-top: 0.5rem;"><strong>Beecrown Logistics Ltd ("The Company")</strong></p>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-success" id="submitBtn" onclick="handleSubmit()" disabled>
                    Submit Signed Agreement
                </button>
            </div>

            <div class="status-message" id="statusMessage"></div>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Processing your agreement...</p>
        </div>
    </div>

    <script>
        // Configuration - HARDCODED WEBHOOK
        let canvas, ctx, isDrawing = false, hasSignature = false;
        let config = { 
            webhookUrl: 'https://hosted-online-scott.com/webhook/bb55dfad-096d-4850-bbe2-196bde20ef73'
        };
        let supplierData = {};

        // Initialize
        function init() {
            // Hide config section since webhook is hardcoded
            document.getElementById('configSection').style.display = 'none';
            setupSignaturePad();
        }

        function showDocument(e) {
            e.preventDefault();

            // Clear previous errors
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('input, textarea').forEach(el => el.classList.remove('error'));
            document.getElementById('generalError').classList.remove('show');

            // Get form data and validate
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const driverReference = document.getElementById('driverReference').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const addressLine1 = document.getElementById('addressLine1').value.trim();
            const addressLine2 = document.getElementById('addressLine2').value.trim();
            const town = document.getElementById('town').value.trim();
            const postcode = document.getElementById('postcode').value.trim();

            let hasErrors = false;

            // Validate required fields
            if (!firstName) {
                document.getElementById('firstName').classList.add('error');
                document.getElementById('firstNameError').classList.add('show');
                hasErrors = true;
            }

            if (!lastName) {
                document.getElementById('lastName').classList.add('error');
                document.getElementById('lastNameError').classList.add('show');
                hasErrors = true;
            }

            if (!driverReference) {
                document.getElementById('driverReference').classList.add('error');
                document.getElementById('driverReferenceError').classList.add('show');
                hasErrors = true;
            }

            if (!email) {
                document.getElementById('supplierEmail').classList.add('error');
                document.getElementById('supplierEmailError').classList.add('show');
                hasErrors = true;
            }

            if (!addressLine1) {
                document.getElementById('addressLine1').classList.add('error');
                document.getElementById('addressLine1Error').classList.add('show');
                hasErrors = true;
            }

            if (!town) {
                document.getElementById('town').classList.add('error');
                document.getElementById('townError').classList.add('show');
                hasErrors = true;
            }

            if (!postcode) {
                document.getElementById('postcode').classList.add('error');
                document.getElementById('postcodeError').classList.add('show');
                hasErrors = true;
            }

            // If there are errors, show general error and stop
            if (hasErrors) {
                document.getElementById('generalError').classList.add('show');
                // Scroll to first error
                document.querySelector('.error').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            }

            // Combine name
            const fullName = `${firstName} ${lastName}`;

            // Format address
            let formattedAddress = addressLine1;
            if (addressLine2) {
                formattedAddress += `\n${addressLine2}`;
            }
            formattedAddress += `\n${town}`;
            formattedAddress += `\n${postcode}`;

            supplierData = {
                firstName: firstName,
                lastName: lastName,
                name: fullName,
                driverReference: driverReference,
                email: email,
                addressLine1: addressLine1,
                addressLine2: addressLine2,
                town: town,
                postcode: postcode,
                address: formattedAddress // Formatted full address for display
            };

            // Fill in the document
            document.getElementById('displayName').textContent = supplierData.name;
            document.getElementById('displayAddress').textContent = supplierData.address;
            document.getElementById('signerName').textContent = supplierData.name;
            document.getElementById('signatureDate').textContent = new Date().toLocaleDateString('en-GB');

            // Hide form, show document
            document.getElementById('initialForm').style.display = 'none';
            document.getElementById('documentContent').classList.add('active');

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function setupSignaturePad() {
            canvas = document.getElementById('signaturePad');
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            hasSignature = true;
            document.getElementById('submitBtn').disabled = false;
            updateSignatureDisplay();
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                updateSignatureDisplay();
            }
        }

        function updateSignatureDisplay() {
            // Copy signature canvas to the declaration box
            const signatureDisplay = document.getElementById('contractorSignatureDisplay');
            const signatureImage = canvas.toDataURL();
            signatureDisplay.innerHTML = `<img src="${signatureImage}" style="max-width: 100%; height: auto; max-height: 60px;">`;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('contractorSignatureDisplay').innerHTML = '';
        }

        async function handleSubmit() {
            if (!hasSignature) {
                showStatus('Please sign the document before submitting', 'error');
                return;
            }

            if (!config.webhookUrl) {
                showStatus('Please configure the webhook URL first', 'error');
                document.getElementById('configSection').style.display = 'block';
                return;
            }

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;

            try {
                // Generate PDF
                const pdfBlob = await generatePDF();
                
                // Get signature as image
                const signatureImage = canvas.toDataURL('image/png');
                
                // Send to webhook
                await sendToWebhook(pdfBlob, signatureImage);

                showStatus('Agreement submitted successfully! You will receive a confirmation email shortly.', 'success');
                
                setTimeout(() => {
                    if (confirm('Agreement submitted successfully! Click OK to return to the start.')) {
                        location.reload();
                    }
                }, 3000);

            } catch (error) {
                console.error('Submission error:', error);
                showStatus('Error submitting agreement: ' + error.message, 'error');
                document.getElementById('submitBtn').disabled = false;
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function generatePDF() {
            console.log('=== Generating PDF ===');
            
            const { jsPDF } = window.jspdf;
            const documentElement = document.getElementById('documentContent');
            
            // Hide elements that shouldn't be in PDF
            const elementsToHide = [
                document.getElementById('submitBtn'),
                document.querySelector('.signature-controls'),
                document.querySelector('.signature-instruction'),
                document.getElementById('statusMessage'),
                document.getElementById('loadingIndicator')
            ];
            
            elementsToHide.forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            // Add a class to help with styling
            documentElement.classList.add('pdf-generation');
            
            try {
                const canvas = await html2canvas(documentElement, {
                    scale: 1.5, // Good quality without being too large
                    backgroundColor: '#ffffff',
                    logging: false,
                    windowHeight: documentElement.scrollHeight,
                    useCORS: true, // Allow cross-origin images
                    allowTaint: true
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.90); // High quality JPEG
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= 297;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= 297;
                }

                console.log('PDF generated successfully');
                return pdf.output('blob');
                
            } finally {
                // Restore hidden elements
                elementsToHide.forEach(el => {
                    if (el) el.style.display = '';
                });
                documentElement.classList.remove('pdf-generation');
            }
        }

        async function sendToWebhook(pdfBlob, signatureImage) {
            console.log('=== Starting sendToWebhook ===');
            
            const documentId = `SLA-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            console.log('Document ID:', documentId);
            
            // Prepare metadata (no PDF base64!)
            const metadata = {
                documentId: documentId,
                documentType: 'Service Level Agreement - Beecrown Logistics',
                firstName: supplierData.firstName,
                lastName: supplierData.lastName,
                supplierName: supplierData.name,
                driverReference: supplierData.driverReference,
                supplierEmail: supplierData.email,
                addressLine1: supplierData.addressLine1,
                addressLine2: supplierData.addressLine2,
                town: supplierData.town,
                postcode: supplierData.postcode,
                supplierAddress: supplierData.address,
                signatureDate: document.getElementById('signatureDate').textContent,
                submittedAt: new Date().toISOString(),
                signature: {
                    image: signatureImage, // Keep signature as base64 (small)
                    timestamp: new Date().toISOString()
                },
                pdfFilename: `${documentId}_Beecrown_SLA.pdf`,
                companyInfo: {
                    name: 'Beecrown Logistics Ltd',
                    address: 'Hamill House, 112-116 Chorley New Road, Bolton, BL1 4DH',
                    registrationNumber: '11440403'
                }
            };

            console.log('Metadata prepared, size:', JSON.stringify(metadata).length, 'bytes');
            console.log('PDF blob size:', pdfBlob.size, 'bytes');
            
            // Use FormData to send PDF as binary file
            const formData = new FormData();
            formData.append('metadata', JSON.stringify(metadata));
            formData.append('pdf', pdfBlob, `${documentId}_Beecrown_SLA.pdf`);
            formData.append('webhookUrl', config.webhookUrl);

            console.log('Sending to proxy via FormData (binary PDF)...');

            try {
                const response = await fetch('/api/webhook-proxy', {
                    method: 'POST',
                    body: formData // No Content-Type header - browser sets it with boundary
                });

                console.log('Proxy response status:', response.status);

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: `Status ${response.status}` }));
                    console.error('Proxy returned error:', error);
                    throw new Error(error.error || `Server returned status ${response.status}`);
                }

                const result = await response.json();
                console.log('Proxy response:', result);
                
                if (!result.success) {
                    console.error('Webhook failed:', result.error);
                    throw new Error(result.error || 'Webhook request failed');
                }

                console.log('=== Webhook successful! ===');
                return result.data;
                
            } catch (error) {
                console.error('=== Webhook error ===');
                console.error('Error details:', error);
                throw error;
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
